<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>文件夹预览部署器 - 带目录版</title>
    <style>
        :root { --sidebar-width: 250px; --primary-color: #2563eb; }
        body { font-family: system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: #f1f5f9; }

        /* 左侧侧边栏 */
        #sidebar { 
            width: var(--sidebar-width); background: #fff; border-right: 1px solid #e2e8f0;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; }
        #file-list { flex-grow: 1; overflow-y: auto; list-style: none; padding: 10px; margin: 0; }
        #file-list li { 
            padding: 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer;
            font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: background 0.2s; color: #475569;
        }
        #file-list li:hover { background: #f8fafc; color: var(--primary-color); }
        #file-list li.active { background: #eff6ff; color: var(--primary-color); font-weight: bold; }

        /* 右侧主内容区 */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .toolbar { padding: 10px 20px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; }
        #preview-frame { width: 100%; flex-grow: 1; border: none; background: #fff; }
        
        /* 初始状态 */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94a3b8; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0 0 10px 0; font-size: 16px;">项目文件</h3>
            <label style="background: var(--primary-color); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; display: inline-block;">
                上传文件夹
                <input type="file" id="folder-input" webkitdirectory directory multiple hidden>
            </label>
        </div>
        <ul id="file-list">
            <div class="empty-state" style="font-size: 12px; padding-top: 20px;">暂无文件</div>
        </ul>
    </div>

    <div id="main-content">
        <div class="toolbar">
            <span id="current-file-name" style="font-size: 14px; color: #64748b;">未加载项目</span>
        </div>
        
        <div id="frame-container" style="flex-grow: 1;">
            <div id="initial-view" class="empty-state">
                <p>请在左侧上传文件夹以开始部署</p>
            </div>
            <iframe id="preview-frame" class="hidden"></iframe>
        </div>
    </div>

<script>
    const folderInput = document.getElementById('folder-input');
    const fileListElement = document.getElementById('file-list');
    const previewFrame = document.getElementById('preview-frame');
    const initialView = document.getElementById('initial-view');
    const currentFileNameDisplay = document.getElementById('current-file-name');

    let fileMap = {}; // 存储所有文件的路径映射

    folderInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        fileMap = {};
        fileListElement.innerHTML = ''; // 清空列表
        let htmlFiles = [];

        // 1. 构建路径映射和 HTML 列表
        for (const file of files) {
            // 获取相对路径 (去掉第一层文件夹名)
            const path = file.webkitRelativePath.split('/').slice(1).join('/');
            const blobUrl = URL.createObjectURL(file);
            fileMap[path] = { blobUrl, file };

            if (path.toLowerCase().endsWith('.html')) {
                htmlFiles.push(path);
            }
        }

        // 2. 渲染侧边栏列表
        if (htmlFiles.length > 0) {
            htmlFiles.sort().forEach(path => {
                const li = document.createElement('li');
                li.innerText = path;
                li.title = path;
                li.onclick = () => loadHtmlFile(path, li);
                fileListElement.appendChild(li);
            });

            // 默认加载第一个 HTML (通常是 index.html)
            const indexFile = htmlFiles.find(p => p.toLowerCase().includes('index.html')) || htmlFiles[0];
            loadHtmlFile(indexFile, fileListElement.querySelector('li'));
        } else {
            fileListElement.innerHTML = '<div class="empty-state">未找到 HTML</div>';
        }
    });

    async function loadHtmlFile(path, element) {
        // 样式切换
        document.querySelectorAll('#file-list li').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        // 更新 UI 状态
        initialView.classList.add('hidden');
        previewFrame.classList.remove('hidden');
        currentFileNameDisplay.innerText = `正在预览: ${path}`;

        // 读取 HTML 内容并处理资源路径
        const { file } = fileMap[path];
        let content = await file.text();

        // 核心：替换资源路径为 Blob URL
        // 支持替换 src="..." 和 href="..." 中的路径
        for (const [relPath, data] of Object.entries(fileMap)) {
            const escapedPath = relPath.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(['"])(?:\\.\\/)?${escapedPath}(['"])`, 'g');
            content = content.replace(regex, `$1${data.blobUrl}$2`);
        }

        // 写入 Iframe
        const doc = previewFrame.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
    }
</script>
</body>
</html>
